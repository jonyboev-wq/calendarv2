# CalendarV2 Planner

Проект предоставляет планировщик с веб-интерфейсом и API вокруг оптимизатора из `src/scheduler`.

## Структура

- `src/api/` — FastAPI-приложение, которое управляет событиями, гибкими окнами и взаимодействием с оптимизатором.
- `frontend/` — React + Vite интерфейс с формами добавления задач, настройками гибкости и визуализацией свободных слотов.
- `frontend/tests/` — e2e тесты на Playwright для ключевых пользовательских сценариев.

## Запуск бэкенда

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn src.api.main:app --reload
```

API поднимается на `http://localhost:8000`. Основные эндпоинты:

- `GET /api/schedule` — текущее расписание, свободные окна и настройки дня.
- `POST /api/events` — добавление фиксированных и гибких событий.
- `PUT /api/events/{event_id}` — обновление событий.
- `DELETE /api/events/{event_id}` — удаление события.
- `POST /api/events/{event_id}/complete` — завершение события с пересчётом расписания.
- `PUT /api/settings` — изменение границ рабочего дня.
- `POST /api/proposals` — подбор рекомендуемых временных интервалов.

### macOS: устранение ошибок SSL при `pip install`

При первом запуске на macOS с Python из официального установщика может не хватать доверенных сертификатов, из-за чего `pip` сообщает `certificate verify failed`. Чтобы исправить проблему:

1. Выполните скрипт установки сертификатов (укажите фактическую версию Python):
   ```bash
   open "/Applications/Python 3.11/Install Certificates.command"
   ```
   После завершения окна установщика снова запустите `pip install -r requirements.txt`.
   Если скрипт не завершился из-за той же ошибки `certificate verify failed`, переходите к шагу 2.
2. Если Python установлен через Homebrew, обновите пакет сертификатов:
   ```bash
   brew install certifi
   export SSL_CERT_FILE="$(python3 -m certifi)"
   pip install -r requirements.txt
   ```
3. Для Python из официального установщика, когда шаг 1 завершается ошибкой, можно вручную выгрузить системные сертификаты и указать их `pip`:
   ```bash
   security find-certificate -a -p /System/Library/Keychains/SystemRootCertificates.keychain > ~/Desktop/macos_system_roots.pem
   export SSL_CERT_FILE=~/Desktop/macos_system_roots.pem
   pip install -r requirements.txt
   ```
   После успешной установки зависимостей переменную окружения можно убрать, а созданный файл — удалить.
4. В крайнем случае можно указать доверенные хосты вручную (не рекомендуется как постоянное решение):
   ```bash
   pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org -r requirements.txt
   ```

После установки сертификатов дальнейшие вызовы `pip install` проходят без ошибок.

## Запуск фронтенда

```bash
cd frontend
npm install
npm run dev
```

Vite проксирует запросы `/api/*` на `http://localhost:8000`, поэтому UI сразу общается с запущенным бэкендом. Готовая сборка собирается командой `npm run build`, предпросмотр — `npm run preview`.

### Ошибки прокси в dev-сервере Vite

Если в консоли разработки появляются сообщения вида `http proxy error: /api/events ... ETIMEDOUT`, это значит, что Vite не может добраться до бекенда на `http://localhost:8000`.

1. Убедитесь, что сервер FastAPI действительно запущен и слушает порт `8000`:
   ```bash
   lsof -i tcp:8000
   ```
   Если команда ничего не выводит, перезапустите Uvicorn: `uvicorn src.api.main:app --reload`.
2. Проверьте, что бекенд не упал с ошибкой (например, из-за недостающих зависимостей) и что вы запускаете его в том же окружении, где устанавливали пакеты.
3. При необходимости обновите прокси-цель. Если бекенд запущен на другом хосте или порту, отредактируйте `frontend/vite.config.ts`, изменив значение `target` в секции `server.proxy`.
4. На macOS с активным фаерволом добавьте Uvicorn и Node.js в разрешённые приложения, чтобы локальный трафик не блокировался.

### Режим мок-API для разработки без бэкенда

Если запустить FastAPI не удаётся (например, из-за временных проблем с сертификатами `pip`), фронтенд можно открыть в демонстрационном режиме со статичными данными:

1. Создайте файл `frontend/.env.local` и добавьте флаг:
   ```bash
   echo "VITE_USE_MOCK_API=true" > frontend/.env.local
   ```
2. Перезапустите `npm run dev`. Интерфейс поднимется без прокси-запросов и будет использовать встроенные примеры расписаний. Можно добавлять/завершать задачи и получать рекомендации — изменения будут храниться только в памяти браузера.
3. Уберите или измените значение переменной после того, как сможете снова подключиться к реальному API, чтобы продолжить работу с сервером.

## Тесты

End-to-end сценарии находятся в `frontend/tests/e2e.spec.ts` и моделируют ключевой поток создания гибкого события. Запуск тестов:

```bash
cd frontend
npm install
npx playwright install --with-deps
npm test
```

Тесты используют роутинг Playwright, чтобы изолированно проверить UI без реального бэкенда.

## Дополнительно

- CORS не требуется — прокси на уровне Vite маршрутизирует запросы во время разработки.
- В рабочей среде фронтенд может обращаться к API напрямую по `/api`, если настроить reverse proxy (например, Nginx) или включить CORS в FastAPI.
